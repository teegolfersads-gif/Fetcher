import xml.etree.ElementTree as ET
import urllib.request
import json
from datetime import datetime, timezone
from pathlib import Path

HEADERS = {"User-Agent": "Mozilla/5.0"}

def fetch(url):
    req = urllib.request.Request(url, headers=HEADERS)
    with urllib.request.urlopen(req, timeout=20) as r:
        return r.read()

stories = []
seen = set()

for feed in GOOGLE_RSS:
    root = ET.fromstring(fetch(feed))
    for item in root.findall(".//item"):
        title = item.findtext("title")
        link = item.findtext("link")
        pub = item.findtext("pubDate")

        if not title or not link:
            continue
        if link in seen:
            continue

        seen.add(link)
        stories.append({
            "headline": title,
            "url": link,
            "published_at": pub
        })

Path("us_news.json").write_text(
    json.dumps(
        {
            "fetched_at": datetime.now(timezone.utc).isoformat(),
            "stories": stories
        },
        indent=2
    ),
    encoding="utf-8"
)

print("Fetched", len(stories), "articles")
